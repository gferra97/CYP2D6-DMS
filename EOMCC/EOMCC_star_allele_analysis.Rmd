---
title: "EOMCC_star_allele_analysis"
author: "Gabrielle Ferra"
date: "2025-10-08"
output: html_document
---

## Load libraries
## Load in your EOMCC dataset - this dataset gets formatted by hand, see example.txt in this folder for the correct file format
```{r setup, include=FALSE}
# Load libraries
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(broom)
library(ggplot2)
library(tidyr)
library(purrr)

# Load final dataset
all_data <- read.csv("/Users/gabrielleferra/Desktop/CYP-project/EOMCC_assay/20251002_20251003_20251029_20251126_combined_EOMCC_activity_data.csv",
                     stringsAsFactors = FALSE)
```

## Run the run_star_activity function to get you the EOMCC activity score for each double variant star allele, the single variants that make up each of the star alleles, as well as the WT, empty vector, and null (C443H) strains
## This function also determines the 95% CIs for the activity scores
## Significance test is a Wilcoxon signed-rank test that compares each strain's EOMCC activity score to 1 (WT score)
## Also returns RFU plots and .csv files with all of the relevant information
```{r run the function}

# Define run_star_activity function
run_star_activity <- function(
    all_data,
    star_allele,              # e.g., "CYP2D6*2"
    var_a,                    # e.g., "R296C"
    var_b,                    # e.g., "S486T"
    outdir,
    date_tag    = format(Sys.Date(), "%Y%m%d"),
    cond_keep   = "EOMCC",    # condition you normalize within
    cond_exclude= "No EOMCC", # condition to drop for slope fits
    x_window    = c(10, 50)   # time window (min) for slope fits
){
  # Ensure batch column exists (creates a batch column for single-plate use)
  if (!"batch" %in% names(all_data)) {
    all_data <- all_data %>% dplyr::mutate(batch = "batch1")
  }

  # ----------------------------
  # 1) Define sets, colors, labels, order
  # ----------------------------
  strains_keep <- c(star_allele, var_a, var_b, "WT", "Empty Vector", "C443H")
  order_axis   <- c("WT", "Empty Vector", "C443H", var_b, var_a, star_allele)

  strain_colors <- c(
    setNames("#8a61c6", star_allele),
    setNames("#61BAF6", var_a),
    setNames("#f7665f", var_b),
    "Empty Vector" = "#b6b5b5",
    "C443H"        = "#535d5d",   # Null
    "WT"           = "#1b9e2b"
  )

  axis_labels <- c(
    "WT"           = "Wild Type",
    "Empty Vector" = "Empty Vector",
    "C443H"        = "Null",
    var_b          = var_b,
    var_a          = var_a,
    star_allele    = star_allele
  )

  # ----------------------------
  # 2) Subset data for strains selected in step #1 and make RFU plot
  # ----------------------------
  df <- all_data %>%
    dplyr::filter(strain %in% strains_keep) %>%
    dplyr::mutate(
      strain = factor(
        strain,
        levels = c(star_allele, var_a, var_b, "WT", "C443H", "Empty Vector")
      )
    )

  # RFU plot
  rfu_plot <- ggplot2::ggplot(stats::na.omit(df),
                              ggplot2::aes(x = time, y = rfu, color = strain)) +
    ggplot2::geom_point() +
    ggplot2::geom_smooth(ggplot2::aes(group = strain),
                         method = "gam", se = FALSE) +
    ggplot2::facet_wrap(ggplot2::vars(cond)) +
    ggplot2::xlab("Time (minutes)") + ggplot2::ylab("RFU") +
    ggplot2::coord_cartesian(xlim = x_window) +
    ggplot2::theme_classic() +
    ggplot2::scale_color_manual(values = strain_colors,
                                labels = axis_labels,
                                name   = "Strain") +
    ggplot2::guides(color = ggplot2::guide_legend(
      override.aes = list(shape = 16)
    )) +
    ggplot2::theme(
      axis.title   = ggplot2::element_text(face = "bold", size = 16),
      legend.title = ggplot2::element_text(face = "bold", size = 20),
      axis.text    = ggplot2::element_text(size = 12),
      legend.text  = ggplot2::element_text(size = 18),
      strip.text   = ggplot2::element_text(face = "bold", size = 16)
    )

  # Save RFU plot as .png and .pdf
  ggplot2::ggsave(
    file.path(outdir,
              sprintf("%s_EOMCC_%s_rfu.png", date_tag, gsub("\\*", "_", star_allele))),
    rfu_plot, width = 8, height = 6, dpi = 300
  )
  ggplot2::ggsave(
    file.path(outdir,
              sprintf("%s_EOMCC_%s_rfu.pdf", date_tag, gsub("\\*", "_", star_allele))),
    rfu_plot, width = 8, height = 6
  )

  # ----------------------------
  # 3) Pool slopes for each of the selected strains per batch (plate) and normalize to pooled WT slope from same batch
  # ----------------------------
  slopes_pooled_batch <- df %>%
    dplyr::filter(
      !is.na(time), !is.na(rfu),
      dplyr::between(time, x_window[1], x_window[2]),
      cond != cond_exclude
    ) %>%
    dplyr::group_by(batch, cond, strain) %>%
    dplyr::do(broom::tidy(stats::lm(rfu ~ time, data = .))) %>%
    dplyr::filter(term == "time") %>%
    dplyr::ungroup() %>%
    dplyr::transmute(
      batch,
      cond,
      strain,
      slope    = estimate,
      slope_se = std.error,
      t        = statistic,
      p        = p.value
    ) %>%
    dplyr::arrange(batch, cond, strain)

  # Get WT pooled slopes per batch 
  wt_slopes_batch <- slopes_pooled_batch %>%
    dplyr::filter(cond == cond_keep, strain == "WT") %>%
    dplyr::select(batch, wt_slope = slope, wt_slope_se = slope_se)

  # Normalize each (batch, cond, strain) slope to WT pooled slope from same batch
  slopes_norm_batch <- slopes_pooled_batch %>%
    dplyr::left_join(wt_slopes_batch, by = "batch") %>%
    dplyr::mutate(
      activity_score    = slope / wt_slope,
      activity_score_se = abs(activity_score) *
        sqrt((slope_se / slope)^2 + (wt_slope_se / wt_slope)^2)
    )

  # Only keep cond_keep (EOMCC) for downstream activity
  slopes_norm_eomcc <- slopes_norm_batch %>%
    dplyr::filter(cond == cond_keep)

  # Compute the mean of the batch-level activity scores (pooled slopes) for each strain
  # This will become the bar height in the final plot
  pooled_activity_summary <- slopes_norm_eomcc %>%
    dplyr::group_by(strain) %>%
    dplyr::summarise(
      pooled_activity_mean = mean(activity_score, na.rm = TRUE),
      .groups = "drop"
    )

  # ----------------------------
  # 4) Compute replicate level activity scores (replicate slope/pooled WT slope from the same batch) to get 95% CIs and p-values for all        strain activity scores
  # ----------------------------
  
  # Fit replicate-level slopes for all 6 replicates per strain
  slopes_repl_all <- all_data %>%
    dplyr::filter(
      cond == cond_keep,
      !is.na(time), !is.na(rfu),
      dplyr::between(time, x_window[1], x_window[2])
    ) %>%
    dplyr::group_by(batch, strain, replicate) %>%
    dplyr::do(broom::tidy(stats::lm(rfu ~ time, data = .))) %>%
    dplyr::filter(term == "time") %>%
    dplyr::transmute(batch, strain, replicate, slope = estimate) %>%
    dplyr::ungroup()

  # Get the average WT slope per batch, derived from WT replicate slopes
  wt_pooled_by_batch <- slopes_repl_all %>%
    dplyr::filter(strain == "WT") %>%
    dplyr::group_by(batch) %>%
    dplyr::summarise(
      wt_slope_pooled = mean(slope, na.rm = TRUE),
      .groups = "drop"
    )

  # Replicate-level activity ratios for non-WT strains:
  # normalize each replicate slope to the average WT slope from the same batch
  activity_repl_all <- slopes_repl_all %>%
    dplyr::filter(strain != "WT") %>%
    dplyr::left_join(wt_pooled_by_batch, by = "batch") %>%
    dplyr::mutate(activity_score = slope / wt_slope_pooled)

  # WT replicate-level activity ratios (for WT CI):
  # normalize each WT replicate slope to the average WT slope from the same batch
  wt_activity_repl <- slopes_repl_all %>%
    dplyr::filter(strain == "WT") %>%
    dplyr::left_join(wt_pooled_by_batch, by = "batch") %>%
    dplyr::mutate(activity_score = slope / wt_slope_pooled)

  # WT activity stats across all batches (for WT CI on the activity scale)
  wt_stats_all <- wt_activity_repl %>%
    dplyr::summarise(
      n_wt        = dplyr::n(),
      mean_wt_act = mean(activity_score, na.rm = TRUE),
      sd_wt_act   = stats::sd(activity_score,   na.rm = TRUE),
      se_wt_act   = sd_wt_act / sqrt(n_wt),
      ci_low_wt   = mean_wt_act - stats::qt(0.975, n_wt - 1) * se_wt_act,
      ci_high_wt  = mean_wt_act + stats::qt(0.975, n_wt - 1) * se_wt_act,
      .groups     = "drop"
    )

  # WT CI values
  wt_rel_ci_all <- wt_stats_all %>%
    dplyr::transmute(
      wt_rel_ci_low  = ci_low_wt,
      wt_rel_ci_high = ci_high_wt
    )

  # Ratio test vs 1 for all strains
  # Also get CIs for all strains
  stats_ratio_all <- activity_repl_all %>%
    dplyr::group_by(strain) %>%
    dplyr::summarise(
      n             = dplyr::n(),
      mean_activity = mean(activity_score, na.rm = TRUE),
      sd_activity   = stats::sd(activity_score,   na.rm = TRUE),
      se_activity   = sd_activity / sqrt(n),
      t_stat_ratio  = (mean_activity - 1) / se_activity,
      df_ratio      = n - 1,
      p_value_ratio = 2 * stats::pt(abs(t_stat_ratio), df_ratio, lower.tail = FALSE),
      ci_low_ratio  = mean_activity - stats::qt(0.975, df_ratio) * se_activity,
      ci_high_ratio = mean_activity + stats::qt(0.975, df_ratio) * se_activity,
      .groups       = "drop"
    )

  # ----------------------------
  # Wilcoxon signed-rank test on activity ratios vs 1 
  # ----------------------------
  stats_wilcox_all <- activity_repl_all %>%
    dplyr::group_by(strain) %>%
    dplyr::summarise(
      p_value_wilcox = tryCatch(
        stats::wilcox.test(activity_score, mu = 1, exact = FALSE)$p.value,
        error = function(e) NA_real_
      ),
      .groups = "drop"
    )

  # Combine both tests globally + BH correction globally
  stats_combined_all <- stats_ratio_all %>%
    dplyr::left_join(stats_wilcox_all, by = "strain") %>%
    dplyr::mutate(
      p_adj_ratio   = p.adjust(p_value_ratio,   method = "BH"),
      p_adj_wilcox  = p.adjust(p_value_wilcox,  method = "BH")
    )

  # ----------------------------
  # 5) Now subset those global stats to our 6 strains
  # ----------------------------
  stats_combined <- stats_combined_all %>%
    dplyr::filter(strain %in% strains_keep)

  # Results table: per-batch pooled + global replicate stats
  results_table <- slopes_norm_eomcc %>%
    dplyr::left_join(stats_combined, by = "strain") %>%
    dplyr::mutate(
      test_note = "activity_score from pooled slopes normalized to WT per batch; replicate activity ratios normalized to pooled WT per batch; stats (p_adj_*) computed once globally across all strains and batches."
    )

  if (nrow(wt_stats_all) == 1) {
    results_table <- results_table %>%
      dplyr::mutate(
        wt_n       = wt_stats_all$n_wt[1],
        wt_mean_activity = wt_stats_all$mean_wt_act[1],
        wt_sd_activity   = wt_stats_all$sd_wt_act[1],
        wt_ci_low_activity  = wt_stats_all$ci_low_wt[1],
        wt_ci_high_activity = wt_stats_all$ci_high_wt[1]
      )
  }

  utils::write.csv(
    results_table,
    file.path(outdir,
              sprintf("%s_%s_EOMCC_activity_score_analysis.csv",
                      date_tag, gsub("\\*", "_", star_allele))),
    row.names = FALSE
  )

  # ----------------------------
  # 6) Plot summary:
  #   bar height = pooled_activity_mean 
  #   CI width   = from global replicate activity ratios (normalized to average WT slopes per batch)
  #   WT: CI from global wt_rel_ci_all, centered at 1
  # ----------------------------
  plot_stats_var <- stats_combined %>%
    dplyr::select(strain,
                  mean_activity,
                  ci_low_ratio,
                  ci_high_ratio,
                  p_value_wilcox,
                  p_adj_wilcox)

  wt_plot_stats <- dplyr::tibble(
    strain         = "WT",
    mean_activity  = 1,
    ci_low_ratio   = wt_rel_ci_all$wt_rel_ci_low[1],
    ci_high_ratio  = wt_rel_ci_all$wt_rel_ci_high[1],
    p_value_wilcox = NA_real_,
    p_adj_wilcox   = NA_real_
  )

  plot_stats_all <- dplyr::bind_rows(wt_plot_stats, plot_stats_var) %>%
    dplyr::filter(strain %in% strains_keep)

  plot_summary <- pooled_activity_summary %>%
    dplyr::left_join(plot_stats_all, by = "strain") %>%
    dplyr::mutate(
      half_width   = (ci_high_ratio - ci_low_ratio) / 2,
      ci_low_plot  = pooled_activity_mean - half_width,
      ci_high_plot = pooled_activity_mean + half_width,
      strain       = factor(strain, levels = order_axis),
      sig = dplyr::case_when(
        is.na(p_value_wilcox) ~ "",
        p_value_wilcox < 0.001 ~ "***",
        p_value_wilcox < 0.01  ~ "**",
        p_value_wilcox < 0.05  ~ "*",
        TRUE                   ~ ""
      )
    )

  p_activity <- ggplot2::ggplot(
    plot_summary,
    ggplot2::aes(x = strain, y = pooled_activity_mean, fill = strain)
  ) +
    ggplot2::geom_col(width = 0.7, color = "black",
                      linewidth = 0.2, show.legend = FALSE) +
    ggplot2::geom_errorbar(
      ggplot2::aes(ymin = ci_low_plot, ymax = ci_high_plot),
      width = 0.2
    ) +
    ggplot2::geom_hline(yintercept = 1, linetype = "dashed") +
    ggplot2::geom_text(
      ggplot2::aes(
        y     = ifelse(is.finite(ci_high_plot),
                       ci_high_plot, pooled_activity_mean) + 0.06,
        label = sig
      ),
      vjust = 0, size = 6
    ) +
    ggplot2::scale_fill_manual(values = strain_colors) +
    ggplot2::scale_x_discrete(labels = axis_labels) +
    ggplot2::labs(
      x = "Strain",
      y = sprintf("%s activity score (normalized to WT = 1)", cond_keep),
      caption = "Bars: pooled slopes normalized to WT per batch. Error bars & stars: global replicate activity ratios normalized to pooled WT per batch."
    ) +
    ggplot2::coord_cartesian(
      ylim = c(0, max(plot_summary$ci_high_plot, na.rm = TRUE) + 0.25)
    ) +
    ggplot2::theme_classic() +
    ggplot2::theme(
      axis.title = ggplot2::element_text(face = "bold", size = 16),
      axis.text  = ggplot2::element_text(size = 12)
    )

  # Save plot as .png and .pdf
  ggplot2::ggsave(
    file.path(outdir,
              sprintf("%s_%s_EOMCC_activity_scores_plot.png",
                      date_tag, gsub("\\*", "_", star_allele))),
    p_activity, width = 8, height = 6, dpi = 300
  )
  ggplot2::ggsave(
    file.path(outdir,
              sprintf("%s_%s_EOMCC_activity_scores_plot.pdf",
                      date_tag, gsub("\\*", "_", star_allele))),
    p_activity, width = 8, height = 6
  )

  # ----------------------------
  # return everything useful
  # ----------------------------
  return(list(
    rfu_plot                = rfu_plot,
    p_activity              = p_activity,
    results_table           = results_table,
    plot_summary            = plot_summary,
    slopes_pooled_batch     = slopes_pooled_batch,
    slopes_norm_batch       = slopes_norm_batch,
    slopes_norm_eomcc       = slopes_norm_eomcc,
    pooled_activity_summary = pooled_activity_summary,
    slopes_repl_all         = slopes_repl_all,
    wt_pooled_by_batch      = wt_pooled_by_batch,
    wt_activity_repl        = wt_activity_repl,
    activity_repl_all       = activity_repl_all,
    stats_ratio_all         = stats_ratio_all,
    stats_wilcox_all        = stats_wilcox_all,
    stats_combined_all      = stats_combined_all,
    stats_combined          = stats_combined,
    wt_stats_all            = wt_stats_all,
    wt_rel_ci_all           = wt_rel_ci_all
  ))
}

```

## Run the function for different star alleles - choose your star alleles and define your directories
```{r run the function}

# CYP2D6*10
res_star10 <- run_star_activity(
  all_data    = all_data,
  star_allele = "CYP2D6*10",
  var_a       = "P34S",
  var_b       = "S486T",
  outdir      = "/Users/gabrielleferra/Desktop/CYP-project/EOMCC_assay/EOMCC_final_analysis/20251209",
  date_tag    = "20251226_wilcoxon_nonBHadjusted"
)

# CYP2D6*2
res_star2 <- run_star_activity(
  all_data    = all_data,
  star_allele = "CYP2D6*2",
  var_a       = "R296C",
  var_b       = "S486T",
  outdir      = "/Users/gabrielleferra/Desktop/CYP-project/EOMCC_assay/EOMCC_final_analysis/20251209",
  date_tag    = "20251226_wilcoxon_nonBHadjusted"
)

# CYP2D6*53
res_star53 <- run_star_activity(
  all_data    = all_data,
  star_allele = "CYP2D6*53",
  var_a       = "A122S",
  var_b       = "F120I",
  outdir      = "/Users/gabrielleferra/Desktop/CYP-project/EOMCC_assay/EOMCC_final_analysis/20251209",
  date_tag    = "20251226_wilcoxon_nonBHadjusted"
)

# CYP2D6*164
res_star164 <- run_star_activity(
  all_data    = all_data,
  star_allele = "CYP2D6*164",
  var_a       = "V136I",
  var_b       = "S486T",
  outdir      = "/Users/gabrielleferra/Desktop/CYP-project/EOMCC_assay/EOMCC_final_analysis/20251209",
  date_tag    = "20251226_wilcoxon_nonBHadjusted"
)

# CYP2D6*88
res_star88 <- run_star_activity(
  all_data    = all_data,
  star_allele = "CYP2D6*88",
  var_a       = "V104A",
  var_b       = "S486T",
  outdir      = "/Users/gabrielleferra/Desktop/CYP-project/EOMCC_assay/EOMCC_final_analysis/20251209",
  date_tag    = "20251226_wilcoxon_nonBHadjusted"
)

# CYP2D6*86
res_star86 <- run_star_activity(
  all_data    = all_data,
  star_allele = "CYP2D6*86",
  var_a       = "M279K",
  var_b       = "E278K",
  outdir      = "/Users/gabrielleferra/Desktop/CYP-project/EOMCC_assay/EOMCC_final_analysis/20251209",
  date_tag    = "20251226_wilcoxon_nonBHadjusted"
)

# CYP2D6*108
res_star108 <- run_star_activity(
  all_data    = all_data,
  star_allele = "CYP2D6*108",
  var_a       = "H352R",
  var_b       = "Y355C",
  outdir      = "/Users/gabrielleferra/Desktop/CYP-project/EOMCC_assay/EOMCC_final_analysis/20251209",
  date_tag    = "20251226_wilcoxon_nonBHadjusted"
)

# CYP2D6*127
res_star127 <- run_star_activity(
  all_data    = all_data,
  star_allele = "CYP2D6*127",
  var_a       = "R365H",
  var_b       = "Y355C",
  outdir      = "/Users/gabrielleferra/Desktop/CYP-project/EOMCC_assay/EOMCC_final_analysis/20251209",
  date_tag    = "20251226_wilcoxon_nonBHadjusted"
)

# CYP2D6*168
res_star168 <- run_star_activity(
  all_data    = all_data,
  star_allele = "CYP2D6*168",
  var_a       = "E196K",
  var_b       = "G42E",
  outdir      = "/Users/gabrielleferra/Desktop/CYP-project/EOMCC_assay/EOMCC_final_analysis/20251209",
  date_tag    = "20251226_wilcoxon_nonBHadjusted"
)


```

## Putting all of the data together and making a bar plot with all of the star alleles (must run the two chunks above first)
## Define your directories before running
```{r all_stars_barplot_triplets, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(stringr)
library(tibble)
library(purrr)

# ============================================================
# Bar plot with all of the star alleles 
# Uses the data generated from the run_star_activity function
#   - bar height = pooled_activity_mean
#   - error bars = ci_low_plot / ci_high_plot
#   - significance stars      = sig
# ============================================================

# ----------------------------
# 1) Star allele config in the exact order you want
# ----------------------------
star_cfg <- tribble(
  ~star,        ~var_a,   ~var_b,
  "CYP2D6*2",    "R296C",  "S486T",
  "CYP2D6*10",   "P34S",   "S486T",
  "CYP2D6*53",   "A122S",  "F120I",
  "CYP2D6*86",   "M279K",  "E278K",
  "CYP2D6*88",   "V104A",  "S486T",
  "CYP2D6*108",  "H352R",  "Y355C",
  "CYP2D6*127",  "R365H",  "Y355C",
  "CYP2D6*164",  "V136I",  "S486T",
  "CYP2D6*168",  "E196K",  "G42E"
)

# ----------------------------
# 2) Named list of run outputs (must already exist by running the chunk above)
# ----------------------------
res_list <- list(
  "CYP2D6*2"    = res_star2,
  "CYP2D6*10"   = res_star10,
  "CYP2D6*53"   = res_star53,
  "CYP2D6*86"   = res_star86,
  "CYP2D6*88"   = res_star88,
  "CYP2D6*108"  = res_star108,
  "CYP2D6*127"  = res_star127,
  "CYP2D6*164"  = res_star164,
  "CYP2D6*168"  = res_star168
)

# ----------------------------
# 3) Colors
# ----------------------------
wt_col     <- "#1f77b4"  # WT: blue
ev_col     <- "#b6b5b5"  # EV: gray
null_col   <- "#d62728"  # Null: red
single_col <- "#6ecdc4"  # all singles: seafoam
double_col <- "#2a8f87"  # all star alleles: darker teal

fill_map <- c(
  "WT"           = wt_col,
  "Empty Vector" = ev_col,
  "C443H"        = null_col,
  "SINGLE"       = single_col,
  "STAR"         = double_col
)

# ----------------------------
# 4) Helper function: pulls out bar-plot numbers (bar height, error bars, sig) for ONE strain from ONE res object
# ----------------------------
get_one <- function(res_obj, strain_name){
  ps <- res_obj$plot_summary %>% mutate(strain = as.character(strain))
  out <- ps %>% filter(strain == strain_name)

  if(nrow(out) == 0){
    return(tibble(
      strain = strain_name,
      pooled_activity_mean = NA_real_,
      ci_low_plot  = NA_real_,
      ci_high_plot = NA_real_,
      sig = ""
    ))
  }

  out %>%
    select(strain, pooled_activity_mean, ci_low_plot, ci_high_plot, sig) %>%
    slice(1)
}

# ----------------------------
# 5) Get controls (WT/EV/Null) â€” use any res object (here I am using the res object for CYP2D6*10)
#    - controls will be plotted once 
# ----------------------------
res_any <- res_star10

controls <- bind_rows(
  get_one(res_any, "WT"),
  get_one(res_any, "Empty Vector"),
  get_one(res_any, "C443H")
) %>%
  mutate(display_strain = strain, fill_key = strain)

# ----------------------------
# 6) Build triplets (duplicates allowed): var_a_tag, var_b_tag, star
# ----------------------------
triplets <- pmap_dfr(star_cfg, function(star, var_a, var_b){
  tag <- str_remove(star, "CYP2D6\\*")
  res_obj <- res_list[[star]]

  bind_rows(
    get_one(res_obj, var_a) %>% mutate(display_strain = paste0(var_a, "_", tag), fill_key = "SINGLE"),
    get_one(res_obj, var_b) %>% mutate(display_strain = paste0(var_b, "_", tag), fill_key = "SINGLE"),
    get_one(res_obj, star)  %>% mutate(display_strain = star,                fill_key = "STAR")
  )
})

df_plot <- bind_rows(controls, triplets)

# ----------------------------
# 7) X-axis order with spacers between triplets
# ----------------------------
x_order <- c("WT", "Empty Vector", "C443H", "spacer_ctrl")

for(i in seq_len(nrow(star_cfg))){
  star <- star_cfg$star[i]
  a    <- star_cfg$var_a[i]
  b    <- star_cfg$var_b[i]
  tag  <- str_remove(star, "CYP2D6\\*")

  x_order <- c(x_order, paste0(a, "_", tag), paste0(b, "_", tag), star)

  if(i < nrow(star_cfg)){
    x_order <- c(x_order, sprintf("spacer_%02d", i))
  }
}

df_plot <- df_plot %>%
  mutate(display_strain = factor(display_strain, levels = x_order))

# ----------------------------
# 8) Star allele labels above each triplet
# ----------------------------
star_labels_df <- tibble(
  label = star_cfg$star,
  x     = map_dbl(seq_len(nrow(star_cfg)), function(i){
    tag <- str_remove(star_cfg$star[i], "CYP2D6\\*")
    a   <- paste0(star_cfg$var_a[i], "_", tag)
    b   <- paste0(star_cfg$var_b[i], "_", tag)
    s   <- star_cfg$star[i]
    mean(match(c(a, b, s), levels(df_plot$display_strain)))
  })
)

y_top <- max(df_plot$ci_high_plot, na.rm = TRUE)
star_labels_df <- star_labels_df %>% mutate(y = y_top + 0.18)

# ----------------------------
# 9) Plot: BAR + CI + significance stars, with cleaned x-axis labels
# ----------------------------
p_allstars_bar <- ggplot(
  df_plot,
  aes(x = display_strain, y = pooled_activity_mean, fill = fill_key)
) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_col(width = 0.7, color = "black", linewidth = 0.2) +
  geom_errorbar(aes(ymin = ci_low_plot, ymax = ci_high_plot),
                width = 0.25, linewidth = 0.7) +
  geom_text(aes(y = ci_high_plot + 0.03, label = sig),
            vjust = 0, size = 6) +
  geom_text(
    data = star_labels_df,
    aes(x = x, y = y, label = label),
    inherit.aes = FALSE,
    size = 4,           # smaller star labels
    fontface = "bold"
  ) +
  scale_fill_manual(values = fill_map, drop = FALSE) +
  scale_x_discrete(
    drop = FALSE,
    labels = function(x){
      out <- x

      # hide spacers
      out[grepl("^spacer_", x)] <- ""

      # rename controls
      out[out == "Empty Vector"] <- "EV"
      out[out == "C443H"] <- "Null"

      # strip _number suffix from singles for display (S486T_10 -> S486T)
      out <- sub("_[0-9]+$", "", out)

      # replace star allele tick labels with "varA + varB"
      for(i in seq_len(nrow(star_cfg))){
        star <- star_cfg$star[i]
        a    <- star_cfg$var_a[i]
        b    <- star_cfg$var_b[i]
        out[out == star] <- paste(a, "+", b)
      }

      out
    }
  ) +
  labs(
    x = NULL,
    y = "EOMCC Activity Score",
    caption = "Bars: pooled slopes normalized to WT per batch. Error bars & stars: global replicate stats across all strains/batches."
  ) +
  coord_cartesian(ylim = c(0, y_top + 0.35)) +
  theme_classic() +
  theme(
    legend.position = "none",
    axis.title = element_text(face = "bold", size = 16),
    axis.text.x = element_text(angle = 35, hjust = 1, size = 13, color = "black"),
    axis.text.y = element_text(size = 12, color = "black"),
    axis.ticks.x = element_blank()
  )

print(p_allstars_bar)

# ----------------------------
# 10) Save plot as .png and .pdf
# ----------------------------
outdir   <- "/Users/gabrielleferra/Desktop/CYP-project/EOMCC_assay/EOMCC_final_analysis/20251209"
date_tag <- "20251226_wilcoxon_nonBHadjusted"

ggsave(file.path(outdir, sprintf("%s_ALL_STARS_barplot_triplets.png", date_tag)),
       p_allstars_bar, width = 14, height = 6, dpi = 300)

ggsave(file.path(outdir, sprintf("%s_ALL_STARS_barplot_triplets.pdf", date_tag)),
       p_allstars_bar, width = 14, height = 6)
```
